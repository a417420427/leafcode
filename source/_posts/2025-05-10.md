---
title: æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰
date: 2025-05-10 17:00:00
tags: js
---

## ğŸŒ³ ä»€ä¹ˆæ˜¯ ASTï¼Ÿ

- æŠ½è±¡è¯­æ³•æ ‘æ˜¯æºä»£ç çš„ç»“æ„åŒ–è¡¨ç¤ºï¼Œä½†å®ƒåªä¿ç•™ä»£ç çš„è¯­æ³•ç»“æ„æ ¸å¿ƒä¿¡æ¯ï¼Œå¿½ç•¥è¯­æ³•ç³–ï¼ˆå¦‚æ‹¬å·ã€æ¢è¡Œç­‰ï¼‰æˆ–å…¶ä»–ä¸å½±å“è¯­ä¹‰çš„ç»†èŠ‚ã€‚

- å®ƒæ˜¯ä¸€æ£µæ ‘ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä»£ç ä¸­çš„ä¸€ä¸ªç»“æ„å•ä½ï¼šè¿ç®—ç¬¦ã€å˜é‡ã€å‡½æ•°ã€è¯­å¥å—ç­‰ã€‚


<!-- more -->

## ç¤ºä¾‹

```js
2 + 3 * (4 - 1);
```

ç”Ÿæˆçš„ AST å¯èƒ½æ˜¯è¿™æ ·çš„ç»“æ„ï¼ˆç®€åŒ–è¡¨ç¤ºï¼‰ï¼š

```markdown
      +
     / \
    2   *
       / \
      3   -
         / \
        4   1
```

æ¯ä¸ªå†…éƒ¨èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªæ“ä½œç¬¦ï¼Œå¶å­èŠ‚ç‚¹æ˜¯å­—é¢é‡ï¼ˆå¦‚æ•°å­—ï¼‰ã€‚

## ğŸ§© AST çš„å…¸å‹ç”¨é€”

- è¯­æ³•åˆ†æï¼šå°†æºä»£ç è½¬æ¢æˆ AST
- è¯­ä¹‰åˆ†æï¼šæ£€æŸ¥ç±»å‹æˆ–ä½œç”¨åŸŸé”™è¯¯
- ä»£ç ç”Ÿæˆï¼šæŠŠ AST è½¬æ¢ä¸ºæœºå™¨ç æˆ–å­—èŠ‚ç 

## JS ç‰‡æ®µè½¬ AST

æ‰§è¡Œé¡ºåº

- è¯»å– js æ–‡ä»¶ä¸­çš„å­—ç¬¦æµ
- é€šè¿‡è¯æ³•åˆ†æç”Ÿæˆ token
- é€šè¿‡è¯­æ³•åˆ†æ( Parser )ç”Ÿæˆ AST
- ç”Ÿæˆæœºå™¨ç æ‰§è¡Œ

æ•´ä¸ªè§£æè¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š

- åˆ†è¯ï¼šå°†æ•´ä¸ªä»£ç å­—ç¬¦ä¸²åˆ†å‰²æˆæœ€å°è¯­æ³•å•å…ƒæ•°ç»„
- è¯­æ³•åˆ†æï¼šåœ¨åˆ†è¯åŸºç¡€ä¸Šå»ºç«‹åˆ†æè¯­æ³•å•å…ƒä¹‹é—´çš„å…³ç³»

JS Parser æ˜¯ js è¯­æ³•è§£æå™¨ï¼Œå®ƒå¯ä»¥å°† js æºç è½¬æˆ ASTï¼Œå¸¸è§çš„ Parser æœ‰ esprimaã€traceurã€acornã€shift ç­‰ã€‚

### è¯æ³•åˆ†æ

- è¯æ³•åˆ†æï¼Œä¹Ÿç§°ä¹‹ä¸ºæ‰«æï¼ˆscannerï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯è°ƒç”¨ next() æ–¹æ³•ï¼Œä¸€ä¸ªä¸€ä¸ªå­—æ¯çš„æ¥è¯»å–å­—ç¬¦ï¼Œç„¶åä¸å®šä¹‰å¥½çš„ JavaScript å…³é”®å­—ç¬¦åšæ¯”è¾ƒï¼Œç”Ÿæˆå¯¹åº”çš„ Token

```text
ä¾‹å¦‚ var è¿™ä¸‰ä¸ªå­—ç¬¦ï¼Œå®ƒåªèƒ½ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¯­ä¹‰ä¸Šä¸èƒ½å†è¢«åˆ†è§£ï¼Œå› æ­¤å®ƒæ˜¯ä¸€ä¸ª Tokenã€‚
```

- è¯æ³•åˆ†æå™¨é‡Œï¼ŒToken åŒ…æ‹¬ å…³é”®å­— æ ‡è¯†ç¬¦ æ“ä½œç¬¦ æ ‡ç‚¹ç¬¦ ç­‰
- ä¼šè¿‡æ»¤æ‰æºç¨‹åºä¸­çš„æ³¨é‡Šå’Œç©ºç™½å­—ç¬¦ã€æ¢è¡Œç¬¦ã€ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ç­‰
- æœ€ç»ˆï¼Œæ•´ä¸ªä»£ç å°†è¢«åˆ†å‰²è¿›ä¸€ä¸ª tokens åˆ—è¡¨ï¼ˆæˆ–è€…è¯´ä¸€ç»´æ•°ç»„ï¼‰ã€‚

### è¯­æ³•åˆ†æ

è¯­æ³•åˆ†æä¼šå°†è¯æ³•åˆ†æå‡ºæ¥çš„ Token è½¬åŒ–æˆæœ‰è¯­æ³•å«ä¹‰çš„æŠ½è±¡è¯­æ³•æ ‘ç»“æ„

ç¤ºä¾‹ ä½¿ç”¨ babel/parser è½¬æ¢ä»£ç 

```js
import parser from "@babel/parser";
const code = `const astFn = (a) => a + a`;

const ast = parser.parse(code, {
  sourceType: "module",
  plugins: ["jsx"],
});
```

è½¬æ¢ç»“æœ

```json
{
  "type": "File",
  "start": 0,
  "end": 26,
  "loc": {
    "start": {
      "line": 1,
      "column": 0,
      "index": 0
    },
    "end": {
      "line": 1,
      "column": 26,
      "index": 26
    }
  },
  "errors": [],
  "program": {
    "type": "Program",
    "start": 0,
    "end": 26,
    "loc": {
      "start": {
        "line": 1,
        "column": 0,
        "index": 0
      },
      "end": {
        "line": 1,
        "column": 26,
        "index": 26
      }
    },
    "sourceType": "module",
    "interpreter": null,
    "body": [
      {
        "type": "VariableDeclaration",
        "start": 0,
        "end": 26,
        "loc": {
          "start": {
            "line": 1,
            "column": 0,
            "index": 0
          },
          "end": {
            "line": 1,
            "column": 26,
            "index": 26
          }
        },
        "declarations": [
          {
            "type": "VariableDeclarator",
            "start": 6,
            "end": 26,
            "loc": {
              "start": {
                "line": 1,
                "column": 6,
                "index": 6
              },
              "end": {
                "line": 1,
                "column": 26,
                "index": 26
              }
            },
            "id": {
              "type": "Identifier",
              "start": 6,
              "end": 11,
              "loc": {
                "start": {
                  "line": 1,
                  "column": 6,
                  "index": 6
                },
                "end": {
                  "line": 1,
                  "column": 11,
                  "index": 11
                },
                "identifierName": "astFn"
              },
              "name": "astFn"
            },
            "init": {
              "type": "ArrowFunctionExpression",
              "start": 14,
              "end": 26,
              "loc": {
                "start": {
                  "line": 1,
                  "column": 14,
                  "index": 14
                },
                "end": {
                  "line": 1,
                  "column": 26,
                  "index": 26
                }
              },
              "id": null,
              "generator": false,
              "async": false,
              "params": [
                {
                  "type": "Identifier",
                  "start": 15,
                  "end": 16,
                  "loc": {
                    "start": {
                      "line": 1,
                      "column": 15,
                      "index": 15
                    },
                    "end": {
                      "line": 1,
                      "column": 16,
                      "index": 16
                    },
                    "identifierName": "a"
                  },
                  "name": "a"
                }
              ],
              "body": {
                "type": "BinaryExpression",
                "start": 21,
                "end": 26,
                "loc": {
                  "start": {
                    "line": 1,
                    "column": 21,
                    "index": 21
                  },
                  "end": {
                    "line": 1,
                    "column": 26,
                    "index": 26
                  }
                },
                "left": {
                  "type": "Identifier",
                  "start": 21,
                  "end": 22,
                  "loc": {
                    "start": {
                      "line": 1,
                      "column": 21,
                      "index": 21
                    },
                    "end": {
                      "line": 1,
                      "column": 22,
                      "index": 22
                    },
                    "identifierName": "a"
                  },
                  "name": "a"
                },
                "operator": "+",
                "right": {
                  "type": "Identifier",
                  "start": 25,
                  "end": 26,
                  "loc": {
                    "start": {
                      "line": 1,
                      "column": 25,
                      "index": 25
                    },
                    "end": {
                      "line": 1,
                      "column": 26,
                      "index": 26
                    },
                    "identifierName": "a"
                  },
                  "name": "a"
                }
              }
            }
          }
        ],
        "kind": "const"
      }
    ],
    "directives": [],
    "extra": {
      "topLevelAwait": false
    }
  },
  "comments": []
}
```

## å®æˆ˜ å†™ä¸€ä¸ª äºŒåˆ™è¿ç®—çš„ AST

1. å®Œæˆä¸€ä¸ªæœ€ç®€æ˜“çš„ AST å‡½æ•°

```js
const BinaryOp = {
  ADD: "+",
  SUB: "-",
  MUL: "*",
  DIV: "/",
};

class AstTree {
  /**
   * @type {AstTree | number}
   */
  left = null;
  /**
   * @type {AstTree | number}
   */
  right = null;
  /**
   * @type {keyof BinaryOp}
   */
  binaryOp = null;
  constructor(left, right, binaryOp) {
    this.left = left;
    this.right = right;
    this.binaryOp = binaryOp;
  }
}
```

```js
const ast1 = new AstTree(
  new AstTree(1, 2, BinaryOp.ADD),
  new AstTree(3, 4, BinaryOp.DIV),
  BinaryOp.MUL
);

const ast2 = new AstTree(
  new AstTree(5, 6, BinaryOp.SUB),
  new AstTree(7, 8, BinaryOp.MUL),
  BinaryOp.ADD
);

const ast3 = new AstTree(ast1, ast2, BinaryOp.DIV);

console.log(ast3);
```

è¾“å‡º

```json
{
  "left": {
    "left": {
      "left": 1,
      "right": 2,
      "binaryOp": "+"
    },
    "right": {
      "left": 3,
      "right": 4,
      "binaryOp": "/"
    },
    "binaryOp": "*"
  },
  "right": {
    "left": {
      "left": 5,
      "right": 6,
      "binaryOp": "-"
    },
    "right": {
      "left": 7,
      "right": 8,
      "binaryOp": "*"
    },
    "binaryOp": "+"
  },
  "binaryOp": "/"
}
```

2. è¾“å‡º HTML

```js
/**
 * @param {AstTree | number} ast
 * @returns {HTMLElement}
 */
function buildTreeElement(ast) {
  if (typeof ast === "number") {
    const node = document.createElement("div");
    node.className = "node";
    node.innerHTML = `<div class="value">${ast}</div>`;
    return node;
  } else {
    const node = document.createElement("div");
    node.className = "node";

    const value = document.createElement("div");
    value.className = "value";
    value.textContent = ast.binaryOp;

    const children = document.createElement("div");
    children.className = "children";

    const left = buildTreeElement(ast.left);
    const right = buildTreeElement(ast.right);

    // è®°å½•çˆ¶å­èŠ‚ç‚¹çš„ DOM å¯¹è±¡
    nodeLinks.push([value, left.querySelector(".value")]);
    nodeLinks.push([value, right.querySelector(".value")]);

    children.appendChild(left);
    children.appendChild(right);

    node.appendChild(value);
    node.appendChild(children);

    return node;
  }

  const container = document.querySelector(".tree");
  const root = buildTreeElement(ast3);
  container.appendChild(root);
}
```

3. èŠ‚ç‚¹ä¹‹é—´è¿çº¿

```js
function drawLines(svg) {
  const svgBox = svg.getBoundingClientRect();

  for (const [parentEl, childEl] of nodeLinks) {
    const parentBox = parentEl.getBoundingClientRect();
    const childBox = childEl.getBoundingClientRect();

    const x1 = parentBox.left + parentBox.width / 2 - svgBox.left;
    const y1 = parentBox.bottom - svgBox.top;
    const x2 = childBox.left + childBox.width / 2 - svgBox.left;
    const y2 = childBox.top - svgBox.top;

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    svg.appendChild(line);
  }
}

const root = buildTreeElement(ast3);
container.appendChild(root);

setTimeout(() => {
  drawLines(container.querySelector("svg.connector"));
});
```

4. åŠ¨æ€ç”Ÿæˆå†…å®¹

[å®Œæ•´é¡¹ç›®](https://github.com/a417420427/ASTCalculator)
[çº¿ä¸ŠæŸ¥çœ‹åœ°å€](https://secretclubscn.com/ASTCalculator)

